<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title></title>
</head>
<body>
    <div style="height:700px;position:fixed">
        <canvas id="chart" width="400" height=400></canvas>
    </div>
    <!--Script references. -->
    <!--Reference the jQuery library. -->
    <script src="Scripts/jquery.min.js"></script>
    <!--Reference the SignalR library. -->
    <script src="Scripts/jquery.signalR-2.3.0.min.js"></script>
    <!--Reference the autogenerated SignalR hub script. -->
    <script src="signalr/hubs"></script>
    <script src="Scripts/Chart.bundle.js"></script>
    <!--Add script to update the page and send messages.-->
    <script type="text/javascript">
        $(function () {
            var ctx = document.getElementById("chart").getContext('2d');
            var monitorChart = new Chart(ctx, {
                type: 'line',
                options: {
                    maintainAspectRatio: false,
                },
                data: {
                    labels: ["", "", "", "", "", "", "", "", "", ""],
                    datasets: [{
                        label: 'CPU',
                        data: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                        backgroundColor: [
                            'rgba(255, 99, 132, 0.2)',
                        ],
                        borderColor: [
                            'rgba(255,99,132,1)',
                        ],
                        borderWidth: 1
                    }, {
                        label: 'RAM',
                        data: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                        backgroundColor: ["#ffff0069"],
                        borderColor: ["#bcbc05"],
                        borderWidth: 1
                    }]
                },
                options: {
                    scales: {
                        yAxes: [{
                            ticks: {
                                beginAtZero: true,
                                max: 100
                            }
                        }]
                    }
                }
            });

            // Declare a proxy to reference the hub.
            var _connection = $.hubConnection();
            var proxyHubData = _connection.createHubProxy("RealTimeHub");
            console.log(proxyHubData);
            proxyHubData.logging = true;
            console.log("HubName", proxyHubData);
            proxyHubData.on("onConnected", function (data) {
                console.log(data);
                messagingRTC.ConnectionId = this.hubs.MessagingHub.connection.id;
                messagingRTC.Type = ConnectionTypeEnum.Messaging;
            });
            _connection
                .start()
                .done(function () {
                    // console.info(
                    //     "Connected: " +
                    //     hubName.toUpperCase() +
                    //     ", Id: " +
                    //     proxyHubData.connection.id
                    // );
                })
                .catch(function (error) {
                    console.error("Hub error -> " + error);
                    // this.ConnectSignalRProxies(user);
                });

            //setInterval(() => {
            //    proxyHubData.invoke("SendPerformanceMonitorData");
            //}, 10000)
            proxyHubData.on("sendPerformanceData", function (response) {
                var data = JSON.parse(response);
                removeData(monitorChart);
                addData(monitorChart, data, data);
                var canvas = document.getElementById('chart');
                var dataURL = canvas.toDataURL();
                if (parseFloat(data.CPUUsage) >= 90) {
                    proxyHubData.invoke("SendEmailForCPUPeakLoad", dataURL);
                }
                if (parseFloat(data.RAMUsage) >= 85) {
                    proxyHubData.invoke("SendEmailForMemoryPeakLoad", dataURL);
                }
            })
        })




        function addData(chart, label, data) {
            var dateData = new Date(data.Date);
            chart.data.labels.push(dateData.getHours() + ":" + dateData.getMinutes() + ":" + dateData.getSeconds());
            chart.data.datasets[0].data.push(Math.ceil(data.CPUUsage));
            chart.data.datasets[1].data.push(Math.ceil(data.RAMUsage));
            chart.update();

        }

        function removeData(chart) {
            chart.data.labels.splice(0, 1);
            chart.data.datasets.forEach((dataset) => {
                //dataset.data.pop();
                dataset.data.splice(0, 1);
            });
            chart.update();
        }
    </script>
</body>
</html>